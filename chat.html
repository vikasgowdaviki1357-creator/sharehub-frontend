// Get DOM elements safely
const chatBox = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatText");

// ðŸš¨ If this is not the chat page, stop execution safely
if (!chatBox || !chatInput) {
  console.warn("Chat elements not found. chat.js stopped safely.");
} else {
  // Get logged-in user safely
  const currentUser =
    JSON.parse(localStorage.getItem("currentUser"))?.email || "guest@student.com";

  // For now, single shared chat room
  let chats = JSON.parse(localStorage.getItem("chatMessages")) || [];

  // Render messages
  function renderChat() {
    chatBox.innerHTML = "";

    if (chats.length === 0) {
      chatBox.innerHTML =
        "<p style='text-align:center;color:#777'>No messages yet</p>";
      return;
    }

    chats.forEach(msg => {
      const div = document.createElement("div");
      div.className =
        msg.from === currentUser ? "chat-msg me" : "chat-msg other";

      div.innerHTML = `
        <p>${msg.text}</p>
        <span>${msg.time}</span>
      `;

      chatBox.appendChild(div);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  renderChat();

  // Send message (exposed globally for button)
  window.sendMessage = function () {
    const text = chatInput.value.trim();
    if (!text) return;

    chats.push({
      from: currentUser,
      text: text,
      time: new Date().toLocaleTimeString()
    });

    localStorage.setItem("chatMessages", JSON.stringify(chats));
    chatInput.value = "";
    renderChat();
  };
}
